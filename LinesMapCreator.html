<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Lines Map Creator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #2c3e50, #1a2a6c);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }


    .help-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .help-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .help-content {
      position: absolute;
      top: 70px;
      right: 0;
      width: 300px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .help-btn:hover+.help-content,
    .help-content:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .help-content h3 {
      color: #4d9de0;
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .help-content ul {
      padding-left: 20px;
    }

    .help-content li {
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 0.95rem;
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .app-container {
      display: flex;
      gap: 25px;
    }

    .control-panel {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      width: 300px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .panel-section {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
    }

    .panel-title {
      font-size: 1.3rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1.1rem;
    }

    input[type="number"]:focus {
      outline: 2px solid #4d9de0;
      background: rgba(255, 255, 255, 0.15);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #4d9de0;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 5px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      background: #3a7dbd;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-export {
      background: #4CAF50;
    }

    .btn-export:hover {
      background: #3d8b40;
    }

    .btn-import {
      background: #FF9800;
    }

    .btn-import:hover {
      background: #e68a00;
    }

    .btn-reset {
      background: #f44336;
    }

    .btn-reset:hover {
      background: #d32f2f;
    }

    #file-input {
      display: none;
    }

    .map-container {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      overflow: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    .current-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-status-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }

    .map-grid {
      display: inline-block;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      background: rgba(0, 0, 0, 0.4);
      margin: 0 auto;
    }

    .map-row {
      display: flex;
    }

    .map-cell {
      width: 40px;
      height: 40px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      position: relative;
    }

    .map-cell:hover {
      transform: scale(1.1);
      z-index: 2;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
    }

    .status-picker {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .status-option {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .status-option:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
    }

    .status-option.active {
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
    }

    .status-0 {
      background: #2c3e50;
    }

    .rule-section h4 {
      color: #4d9de0;
      margin-bottom: 8px;
    }

    .number-counts {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .number-item {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
    }

    .number-color {
      width: 25px;
      height: 25px;
      border-radius: 4px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      margin-top: 10px;
      padding: 20px;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      border-left: 4px solid #f44336;
    }

    .notification.success {
      border-left: 4px solid #4CAF50;
    }

    @media (max-width: 1100px) {
      .app-container {
        flex-direction: column;
      }

      .control-panel {
        width: 100%;
      }

      .map-grid {
        max-width: 100%;
        overflow-x: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Lines Map Creator</h1>
    </header>

    <div class="app-container">
      <div class="control-panel">
        <div class="panel-section">
          <h2 class="panel-title">üìè Âú∞ÂõæËÆæÁΩÆ</h2>
          <div class="input-group">
            <label for="width">Âú∞ÂõæÂÆΩÂ∫¶ (4-15):</label>
            <input type="number" id="width" min="4" max="15" value="10">
          </div>
          <div class="input-group">
            <label for="height">Âú∞ÂõæÈ´òÂ∫¶ (1-15):</label>
            <input type="number" id="height" min="1" max="15" value="10">
          </div>
          <button id="create-btn" class="btn">
            üîÑ ÂàõÂª∫Âú∞Âõæ
          </button>
        </div>

        <div class="panel-section">

          <h2 class="panel-title">üé® Áä∂ÊÄÅÈÄâÊã©</h2>
          <div class="status-picker" id="status-picker">
            <!-- Áä∂ÊÄÅÈÄâÈ°πÂ∞ÜÈÄöËøáJSÁîüÊàê -->
          </div>
        </div>
      </div>

      <div class="map-container">
        <div class="map-header">
          <h2>üåé Âú∞ÂõæÁºñËæëÂå∫Âüü</h2>
          <div class="help-btn">‚ùì</div>
          <div class="help-content">
            <h3>üìú Âú∞ÂõæÁºñËæëËßÑÂàô</h3>
            <ul>
              <li>ËÆæÁΩÆÂú∞ÂõæÂ∞∫ÂØ∏ÂêéÁÇπÂáª"ÂàõÂª∫Âú∞Âõæ"</li>
              <li>Âú®Âè≥‰æßÈÄâÊã©Ë¶ÅÁªòÂà∂ÁöÑÁä∂ÊÄÅÔºà0-16Ôºâ</li>
              <li>ÁÇπÂáªÂú∞ÂõæÂçïÂÖÉÊ†ºÂ∫îÁî®ÂΩìÂâçÁä∂ÊÄÅ</li>
              <li>Êåâ‰ΩèÈº†Ê†áÊãñÂä®ÂèØËøûÁª≠ÁªòÂà∂</li>
              <li>Ââç‰∏Ä‰∏™Êï∞Â≠óÂ°´Êª°‰∏§‰∏™ÊâçËÉΩÂ°´‰∏ã‰∏Ä‰∏™Êï∞Â≠ó</li>
              <li>ÊØè‰∏™Êï∞Â≠óÊúÄÂ§öÂè™ËÉΩÂ°´‰∏§‰∏™</li>
              <li>‰ΩøÁî®ÂØºÂá∫/ÂØºÂÖ•ÂäüËÉΩ‰øùÂ≠òÂíåÂä†ËΩΩÂú∞Âõæ</li>
            </ul>
          </div>
          <div class="current-status">
            <span>ÂΩìÂâçÁä∂ÊÄÅ:</span>
            <div class="current-status-box" id="current-status-box">0</div>
          </div>
        </div>

        <div class="map-grid" id="map-grid">
          <!-- Âú∞ÂõæÁΩëÊ†ºÂ∞ÜÈÄöËøáJSÁîüÊàê -->
        </div>

        <div class="number-counts" id="number-counts">
          <!-- Êï∞Â≠óËÆ°Êï∞Â∞ÜÈÄöËøáJSÁîüÊàê -->
        </div>
      </div>

      <div class="control-panel">
        <div class="panel-section">
          <h2 class="panel-title">üíæ Êï∞ÊçÆÊìç‰Ωú</h2>
          <button id="import-btn" class="btn btn-import">
            ‚¨ÜÔ∏è ÂØºÂÖ•Âú∞ÂõæÊï∞ÊçÆ
          </button>
          <button id="export-json-btn" class="btn btn-export">
            ‚¨áÔ∏è ÂØºÂá∫Âú∞ÂõæÊï∞ÊçÆ.json
          </button>
          <button id="export-txt-btn" class="btn btn-export">
            ‚¨áÔ∏è ÂØºÂá∫Âú∞ÂõæÊï∞ÊçÆ.txt
          </button>
          <input type="file" id="file-input" accept=".json,.txt">
          <button id="reset-btn" class="btn btn-reset">
            üóëÔ∏è ÈáçÁΩÆÂú∞Âõæ
          </button>
        </div>
      </div>
    </div>

    <footer>
      <p>Lines Map Creator | ÊîØÊåÅËá™ÂÆö‰πâÂ∞∫ÂØ∏ | ÂèØÂØºÂá∫ÂØºÂÖ•Âú∞ÂõæÊï∞ÊçÆ</p>
    </footer>

    <div class="notification" id="notification">
      Êìç‰ΩúÊàêÂäüÔºÅ
    </div>
  </div>

  <script>
    // Áä∂ÊÄÅÈ¢úËâ≤ÈÖçÁΩÆ
    const statusColors = [
      '#2c3e50',   // 0: Ê∑±ËìùËâ≤
      '#e74c3c',   // 1: Á∫¢Ëâ≤
      '#3498db',   // 2: ËìùËâ≤
      '#2ecc71',   // 3: ÁªøËâ≤
      '#f1c40f',   // 4: ÈªÑËâ≤
      '#9b59b6',   // 5: Á¥´Ëâ≤
      '#1abc9c',   // 6: ÈùíËâ≤
      '#e67e22',   // 7: Ê©ôËâ≤
      '#34495e',   // 8: Ê∑±ÁÅ∞Ëâ≤
      '#d35400',   // 9: Ê∑±Ê©ôËâ≤
      '#27ae60',   // 10: Ê∑±ÁªøËâ≤
      '#8e44ad',   // 11: Ê∑±Á¥´Ëâ≤
      '#16a085',   // 12: Ê∑±ÈùíËâ≤
      '#c0392b',   // 13: Ê∑±Á∫¢Ëâ≤
      '#2980b9',   // 14: Ê∑±ËìùËâ≤
      '#f39c12',   // 15: ÈáëËâ≤
      '#7f8c8d'    // 16: ÁÅ∞Ëâ≤
    ];

    // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÁä∂ÊÄÅ
    let currentStatus = 1;
    // Âú∞ÂõæÊï∞ÊçÆ
    let mapData = [];
    // ÊòØÂê¶Ê≠£Âú®ÊãñÂä®
    let isDragging = false;
    // Êï∞Â≠óËÆ°Êï∞
    let numberCounts = Array(17).fill(0);
    // ‰∏ã‰∏Ä‰∏™ÂèØÁî®ÁöÑÊï∞Â≠ó
    let nextAvailableNumber = 1;

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
      // ÂàùÂßãÂåñÁä∂ÊÄÅÈÄâÊã©Âô®
      initStatusPicker();
      // ÂàùÂßãÂåñÊï∞Â≠óËÆ°Êï∞ÊòæÁ§∫
      initNumberCounts();
      // ÂàõÂª∫ÈªòËÆ§Âú∞Âõæ
      createMap(10, 10);
      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
      setupEventListeners();
    });

    // ÂàùÂßãÂåñÁä∂ÊÄÅÈÄâÊã©Âô®
    function initStatusPicker() {
      const picker = document.getElementById('status-picker');

      for (let i = 1; i <= 16; i++) {
        const statusOption = document.createElement('div');
        statusOption.className = `status-option status-${i}`;
        statusOption.style.backgroundColor = statusColors[i];
        statusOption.textContent = i;
        statusOption.dataset.status = i;

        if (i === currentStatus) {
          statusOption.classList.add('active');
        }

        statusOption.addEventListener('click', () => {
          if (i > 0) {
            if (i > nextAvailableNumber) {
              showNotification(`ËØ∑ÂÖàÂÆåÊàêÊï∞Â≠ó${nextAvailableNumber}ÔºàÈúÄË¶ÅÊîæÁΩÆ2‰∏™Ôºâ`, "error");
              return;
            }

            if (numberCounts[i] >= 2) {
              showNotification(`Êï∞Â≠ó${i}Â∑≤ËææÂà∞ÊúÄÂ§ßÊï∞ÈáèÔºà2‰∏™Ôºâ`, "error");
              return;
            }
          }

          currentStatus = i;
          document.getElementById('current-status-box').textContent = i;
          document.getElementById('current-status-box').style.backgroundColor = statusColors[i];

          document.querySelectorAll('.status-option').forEach(opt => {
            opt.classList.remove('active');
          });
          statusOption.classList.add('active');
        });

        picker.appendChild(statusOption);
      }
    }

    // ÂàùÂßãÂåñÊï∞Â≠óËÆ°Êï∞ÊòæÁ§∫
    function initNumberCounts() {
      const container = document.getElementById('number-counts');

      for (let i = 1; i <= 16; i++) {
        const item = document.createElement('div');
        item.className = 'number-item';

        const colorBox = document.createElement('div');
        colorBox.className = 'number-color';
        colorBox.style.backgroundColor = statusColors[i];
        colorBox.textContent = i;

        const countText = document.createElement('span');
        countText.className = 'count-text';
        countText.textContent = `Â∑≤ÊîæÁΩÆ: 0/2`;
        countText.id = `count-${i}`;

        item.appendChild(colorBox);
        item.appendChild(countText);
        container.appendChild(item);
      }
    }

    // Êõ¥Êñ∞Êï∞Â≠óËÆ°Êï∞ÊòæÁ§∫
    function updateNumberCounts() {
      for (let i = 1; i <= 16; i++) {
        const countElement = document.getElementById(`count-${i}`);
        if (countElement) {
          countElement.textContent = `Â∑≤ÊîæÁΩÆ: ${numberCounts[i]}/2`;

          if (numberCounts[i] === 2) {
            countElement.style.color = '#2ecc71';
          } else {
            countElement.style.color = 'white';
          }
        }
      }

      // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ÂèØÁî®Êï∞Â≠ó
      nextAvailableNumber = 1;
      for (let i = 1; i <= 16; i++) {
        if (numberCounts[i] < 2) {
          nextAvailableNumber = i;
          break;
        }
      }
    }

    // ÂàõÂª∫Âú∞Âõæ
    function createMap(width, height) {
      const mapGrid = document.getElementById('map-grid');
      mapGrid.innerHTML = '';

      // ÈáçÁΩÆÊï∞Â≠óËÆ°Êï∞
      numberCounts = Array(17).fill(0);
      updateNumberCounts();

      // ÂàùÂßãÂåñÂú∞ÂõæÊï∞ÊçÆ
      mapData = [];

      for (let y = 0; y < height; y++) {
        const row = document.createElement('div');
        row.className = 'map-row';

        const dataRow = [];

        for (let x = 0; x < width; x++) {
          const cell = document.createElement('div');
          cell.className = 'map-cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.dataset.status = 0;
          cell.style.backgroundColor = statusColors[0];

          // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
          cell.addEventListener('mousedown', startDrawing);
          cell.addEventListener('mouseenter', draw);
          cell.addEventListener('mouseup', stopDrawing);

          row.appendChild(cell);
          dataRow.push(0);
        }

        mapGrid.appendChild(row);
        mapData.push(dataRow);
      }
    }

    // ÂºÄÂßãÁªòÂà∂
    function startDrawing(e) {
      isDragging = true;
      updateCell(e.target);
    }

    // ÁªòÂà∂‰∏≠
    function draw(e) {
      if (isDragging) {
        updateCell(e.target);
      }
    }

    // ÂÅúÊ≠¢ÁªòÂà∂
    function stopDrawing() {
      isDragging = false;
    }

    // Êõ¥Êñ∞ÂçïÂÖÉÊ†º
    function updateCell(cell) {
      const x = parseInt(cell.dataset.x);
      const y = parseInt(cell.dataset.y);
      const currentCellStatus = parseInt(cell.dataset.status);

      // Â¶ÇÊûúÊñ∞Áä∂ÊÄÅÂíåÂΩìÂâçÁä∂ÊÄÅÁõ∏ÂêåÔºå‰∏çÂÅöÊìç‰Ωú
      if (currentCellStatus === currentStatus) {
        if (currentStatus > 0) {
          if (currentCellStatus > 0) {
            numberCounts[currentCellStatus]--;
          }
          cell.dataset.status = 0;
          cell.textContent = '';
          cell.style.backgroundColor = statusColors[0];
        }
      } else {
        // ÁâπÊÆäËßÑÂàôÊ£ÄÊü•
        if (currentStatus > 0) {
          // Ê£ÄÊü•ÊòØÂê¶Êª°Ë∂≥È°∫Â∫èËßÑÂàô
          if (currentStatus > nextAvailableNumber) {
            showNotification(`ËØ∑ÂÖàÂÆåÊàêÊï∞Â≠ó${nextAvailableNumber}ÔºàÈúÄË¶ÅÊîæÁΩÆ2‰∏™Ôºâ`, "error");
            return;
          }

          // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÊúÄÂ§ßÊï∞Èáè
          if (numberCounts[currentStatus] >= 2) {
            showNotification(`Êï∞Â≠ó${currentStatus}Â∑≤ËææÂà∞ÊúÄÂ§ßÊï∞ÈáèÔºà2‰∏™Ôºâ`, "error");
            return;
          }
        }

        // ÂáèÂ∞ëÂéüÁä∂ÊÄÅÁöÑËÆ°Êï∞
        if (currentCellStatus > 0) {
          numberCounts[currentCellStatus]--;
        }

        // Â¢ûÂä†Êñ∞Áä∂ÊÄÅÁöÑËÆ°Êï∞
        if (currentStatus > 0) {
          numberCounts[currentStatus]++;
        }

        // Êõ¥Êñ∞UI
        cell.dataset.status = currentStatus;
        cell.textContent = currentStatus === 0 ? '' : currentStatus;
        cell.style.backgroundColor = statusColors[currentStatus];

        // Êõ¥Êñ∞Êï∞ÊçÆ
        mapData[y][x] = currentStatus;
      }

      // Êõ¥Êñ∞ËÆ°Êï∞ÊòæÁ§∫
      updateNumberCounts();
    }

    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    function setupEventListeners() {
      // ÂàõÂª∫Âú∞ÂõæÊåâÈíÆ
      document.getElementById('create-btn').addEventListener('click', () => {
        const width = parseInt(document.getElementById('width').value) || 10;
        const height = parseInt(document.getElementById('height').value) || 10;

        // ÈôêÂà∂Â∞∫ÂØ∏ËåÉÂõ¥
        const clampedWidth = Math.min(Math.max(width, 4), 15);
        const clampedHeight = Math.min(Math.max(height, 1), 15);

        document.getElementById('width').value = clampedWidth;
        document.getElementById('height').value = clampedHeight;

        createMap(clampedWidth, clampedHeight);
        showNotification(`Â∑≤ÂàõÂª∫ ${clampedWidth}√ó${clampedHeight} Âú∞Âõæ`, "success");
      });

      // ÂØºÂá∫ÊåâÈíÆ
      document.getElementById('export-json-btn').addEventListener('click', () => {
        const data = {
          width: mapData[0].length,
          height: mapData.length,
          data: mapData
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `map-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification("Âú∞ÂõæÊï∞ÊçÆÂ∑≤ÂØºÂá∫", "success");
      });

      // ÂØºÂá∫txtÊåâÈíÆ
      document.getElementById('export-txt-btn').addEventListener('click', () => {
        const width = mapData[0].length;
        const height = mapData.length;

        // ËÆ°ÁÆóÂ∑≤‰ΩøÁî®ÁöÑÊï∞Â≠óÁ±ªÂûãÊï∞Èáè
        updateNumberCounts();

        // ÂáÜÂ§áÂØºÂá∫Êï∞ÊçÆ
        let exportData = `${width} ${height} ${nextAvailableNumber - 1}`;

        // Ê∑ªÂä†Âú∞ÂõæÊï∞ÊçÆ
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            exportData += ` ${mapData[y][x]}`;
          }
        }

        const blob = new Blob([exportData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `map-${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // ÂØºÂÖ•ÊåâÈíÆ
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });

      // Êñá‰ª∂ËæìÂÖ•
      document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.width && data.height && data.data) {
              // Ê£ÄÊü•Â∞∫ÂØ∏ÊòØÂê¶ÊúâÊïà
              const width = Math.min(Math.max(data.width, 3), 40);
              const height = Math.min(Math.max(data.height, 1), 30);

              document.getElementById('width').value = width;
              document.getElementById('height').value = height;

              createMap(width, height);

              // Â∫îÁî®ÂØºÂÖ•ÁöÑÊï∞ÊçÆ
              setTimeout(() => {
                // ÈáçÁΩÆÊï∞Â≠óËÆ°Êï∞
                numberCounts = Array(17).fill(0);

                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    let status = 0;
                    if (y < data.data.length && x < data.data[y].length) {
                      status = data.data[y][x];
                    }

                    // Êõ¥Êñ∞ËÆ°Êï∞
                    if (status > 0) {
                      numberCounts[status]++;
                    }

                    const cell = document.querySelector(`.map-cell[data-x="${x}"][data-y="${y}"]`);

                    if (cell) {
                      cell.dataset.status = status;
                      cell.textContent = status === 0 ? '' : status;
                      cell.style.backgroundColor = statusColors[status];
                      mapData[y][x] = status;
                    }
                  }
                }

                // Êõ¥Êñ∞ËÆ°Êï∞ÊòæÁ§∫
                updateNumberCounts();

                showNotification("Âú∞ÂõæÊï∞ÊçÆÂ∑≤ÂØºÂÖ•", "success");
              }, 100);
            }
          } catch (error) {
            try {
              const text = event.target.result.trim();
              const parts = text.split(/\s+/);

              if (parts.length < 3) {
                throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ");
              }

              // Ëß£ÊûêÂâç‰∏â‰∏™ÂèÇÊï∞
              const width = parseInt(parts[0]);
              const height = parseInt(parts[1]);
              colorTypeCount = parseInt(parts[2]);

              // È™åËØÅÂ∞∫ÂØ∏
              if (width < 3 || width > 40 || height < 1 || height > 30) {
                throw new Error("Âú∞ÂõæÂ∞∫ÂØ∏Êó†Êïà");
              }

              // ËÆ°ÁÆóÊâÄÈúÄÊï∞ÊçÆÈïøÂ∫¶
              const expectedDataLength = width * height;
              if (parts.length !== 3 + expectedDataLength) {
                throw new Error("Êï∞ÊçÆÈïøÂ∫¶‰∏çÂåπÈÖç");
              }

              // Êõ¥Êñ∞Âú∞ÂõæÂ∞∫ÂØ∏
              document.getElementById('width').value = width;
              document.getElementById('height').value = height;

              // ÂàõÂª∫Âú∞ÂõæÁΩëÊ†º
              createMap(width, height);

              // Â∫îÁî®ÂØºÂÖ•ÁöÑÊï∞ÊçÆ
              setTimeout(() => {
                // ÈáçÁΩÆÊï∞Â≠óËÆ°Êï∞
                numberCounts = Array(17).fill(0);

                let dataIndex = 3;
                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    const status = parseInt(parts[dataIndex++]);

                    // Êõ¥Êñ∞ËÆ°Êï∞
                    if (status > 0) {
                      numberCounts[status]++;
                    }

                    const cell = document.querySelector(`.map-cell[data-x="${x}"][data-y="${y}"]`);

                    if (cell) {
                      cell.dataset.status = status;
                      cell.textContent = status === 0 ? '' : status;
                      cell.style.backgroundColor = statusColors[status];
                      mapData[y][x] = status;
                    }
                  }
                }

                // Êõ¥Êñ∞ËÆ°Êï∞ÊòæÁ§∫
                updateNumberCounts();

                showNotification("Âú∞ÂõæÊï∞ÊçÆÂ∑≤ÂØºÂÖ•", "success");
              }, 100);
            } catch (error) {
              showNotification(`ÂØºÂÖ•Â§±Ë¥•: ${error.message}`, "error");
              console.error(error);
            }
          }
        };
        reader.readAsText(file);
      });

      // ÈáçÁΩÆÊåâÈíÆ
      document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÂú∞ÂõæÂêóÔºüÊâÄÊúâÊï∞ÊçÆÂ∞Ü‰∏¢Â§±ÔºÅ')) {
          const width = parseInt(document.getElementById('width').value) || 15;
          const height = parseInt(document.getElementById('height').value) || 10;
          createMap(width, height);
          showNotification("Âú∞ÂõæÂ∑≤ÈáçÁΩÆ", "success");
        }
      });

      // Èò≤Ê≠¢ÊãñÂä®Êó∂ÈÄâ‰∏≠ÊñáÊú¨
      document.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('map-cell')) {
          e.preventDefault();
        }
      });
    }

    // ÊòæÁ§∫ÈÄöÁü•
    function showNotification(message, type = "success") {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type, 'show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>

</html>