<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Lines Map Creator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #2c3e50, #1a2a6c);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }


    .help-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .help-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .help-content {
      position: absolute;
      top: 70px;
      right: 0;
      width: 300px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .help-btn:hover+.help-content,
    .help-content:hover {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .help-content h3 {
      color: #4d9de0;
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .help-content ul {
      padding-left: 20px;
    }

    .help-content li {
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 0.95rem;
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .app-container {
      display: flex;
      gap: 25px;
    }

    .control-panel {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      width: 300px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .panel-section {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
    }

    .panel-title {
      font-size: 1.3rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1.1rem;
    }

    input[type="number"]:focus {
      outline: 2px solid #4d9de0;
      background: rgba(255, 255, 255, 0.15);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #4d9de0;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 5px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      background: #3a7dbd;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-export {
      background: #4CAF50;
    }

    .btn-export:hover {
      background: #3d8b40;
    }

    .btn-import {
      background: #FF9800;
    }

    .btn-import:hover {
      background: #e68a00;
    }

    .btn-reset {
      background: #f44336;
    }

    .btn-reset:hover {
      background: #d32f2f;
    }

    #file-input {
      display: none;
    }

    .map-container {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      overflow: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    .current-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-status-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }

    .map-grid {
      display: inline-block;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      background: rgba(0, 0, 0, 0.4);
      margin: 0 auto;
    }

    .map-row {
      display: flex;
    }

    .map-cell {
      width: 40px;
      height: 40px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
      position: relative;
    }

    .map-cell:hover {
      transform: scale(1.1);
      z-index: 2;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
    }

    .status-picker {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .status-option {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .status-option:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
    }

    .status-option.active {
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
    }

    .status-0 {
      background: #2c3e50;
    }

    .rule-section h4 {
      color: #4d9de0;
      margin-bottom: 8px;
    }

    .number-counts {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .number-item {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 6px;
    }

    .number-color {
      width: 25px;
      height: 25px;
      border-radius: 4px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      margin-top: 10px;
      padding: 20px;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translateX(200%);
      transition: transform 0.4s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      border-left: 4px solid #f44336;
    }

    .notification.success {
      border-left: 4px solid #4CAF50;
    }

    @media (max-width: 1100px) {
      .app-container {
        flex-direction: column;
      }

      .control-panel {
        width: 100%;
      }

      .map-grid {
        max-width: 100%;
        overflow-x: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Lines Map Creator</h1>
    </header>

    <div class="app-container">
      <div class="control-panel">
        <div class="panel-section">
          <h2 class="panel-title">ğŸ“ åœ°å›¾è®¾ç½®</h2>
          <div class="input-group">
            <label for="width">åœ°å›¾å®½åº¦ (4-15):</label>
            <input type="number" id="width" min="4" max="15" value="10">
          </div>
          <div class="input-group">
            <label for="height">åœ°å›¾é«˜åº¦ (1-15):</label>
            <input type="number" id="height" min="1" max="15" value="10">
          </div>
          <button id="create-btn" class="btn">
            ğŸ”„ åˆ›å»ºåœ°å›¾
          </button>
        </div>

        <div class="panel-section">

          <h2 class="panel-title">ğŸ¨ çŠ¶æ€é€‰æ‹©</h2>
          <div class="status-picker" id="status-picker">
            <!-- çŠ¶æ€é€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
          </div>
        </div>
      </div>

      <div class="map-container">
        <div class="map-header">
          <h2>ğŸŒ åœ°å›¾ç¼–è¾‘åŒºåŸŸ</h2>
          <div class="help-btn">â“</div>
          <div class="help-content">
            <h3>ğŸ“œ åœ°å›¾ç¼–è¾‘è§„åˆ™</h3>
            <ul>
              <li>è®¾ç½®åœ°å›¾å°ºå¯¸åç‚¹å‡»"åˆ›å»ºåœ°å›¾"</li>
              <li>åœ¨å³ä¾§é€‰æ‹©è¦ç»˜åˆ¶çš„çŠ¶æ€ï¼ˆ0-16ï¼‰</li>
              <li>ç‚¹å‡»åœ°å›¾å•å…ƒæ ¼åº”ç”¨å½“å‰çŠ¶æ€</li>
              <li>æŒ‰ä½é¼ æ ‡æ‹–åŠ¨å¯è¿ç»­ç»˜åˆ¶</li>
              <li>å‰ä¸€ä¸ªæ•°å­—å¡«æ»¡ä¸¤ä¸ªæ‰èƒ½å¡«ä¸‹ä¸€ä¸ªæ•°å­—</li>
              <li>æ¯ä¸ªæ•°å­—æœ€å¤šåªèƒ½å¡«ä¸¤ä¸ª</li>
              <li>ä½¿ç”¨å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ä¿å­˜å’ŒåŠ è½½åœ°å›¾</li>
            </ul>
          </div>
          <div class="current-status">
            <span>å½“å‰çŠ¶æ€:</span>
            <div class="current-status-box" id="current-status-box">0</div>
          </div>
        </div>

        <div class="map-grid" id="map-grid">
          <!-- åœ°å›¾ç½‘æ ¼å°†é€šè¿‡JSç”Ÿæˆ -->
        </div>

        <div class="number-counts" id="number-counts">
          <!-- æ•°å­—è®¡æ•°å°†é€šè¿‡JSç”Ÿæˆ -->
        </div>
      </div>

      <div class="control-panel">
        <div class="panel-section">
          <h2 class="panel-title">ğŸ’¾ æ•°æ®æ“ä½œ</h2>
          <button id="import-btn" class="btn btn-import">
            â¬†ï¸ å¯¼å…¥åœ°å›¾æ•°æ®
          </button>
          <button id="export-json-btn" class="btn btn-export">
            â¬‡ï¸ å¯¼å‡ºåœ°å›¾æ•°æ®.json
          </button>
          <button id="export-txt-btn" class="btn btn-export">
            â¬‡ï¸ å¯¼å‡ºåœ°å›¾æ•°æ®.txt
          </button>
          <input type="file" id="file-input" accept=".json,.txt">
          <button id="reset-btn" class="btn btn-reset">
            ğŸ—‘ï¸ é‡ç½®åœ°å›¾
          </button>
        </div>
      </div>
    </div>

    <footer>
      <p>Lines Map Creator | æ”¯æŒè‡ªå®šä¹‰å°ºå¯¸ | å¯å¯¼å‡ºå¯¼å…¥åœ°å›¾æ•°æ®</p>
    </footer>

    <div class="notification" id="notification">
      æ“ä½œæˆåŠŸï¼
    </div>
  </div>

  <script>
    // çŠ¶æ€é¢œè‰²é…ç½®
    const statusColors = [
      '#2c3e50',   // 0: æ·±è“è‰²
      '#e74c3c',   // 1: çº¢è‰²
      '#3498db',   // 2: è“è‰²
      '#2ecc71',   // 3: ç»¿è‰²
      '#f1c40f',   // 4: é»„è‰²
      '#9b59b6',   // 5: ç´«è‰²
      '#1abc9c',   // 6: é’è‰²
      '#e67e22',   // 7: æ©™è‰²
      '#34495e',   // 8: æ·±ç°è‰²
      '#d35400',   // 9: æ·±æ©™è‰²
      '#27ae60',   // 10: æ·±ç»¿è‰²
      '#8e44ad',   // 11: æ·±ç´«è‰²
      '#16a085',   // 12: æ·±é’è‰²
      '#c0392b',   // 13: æ·±çº¢è‰²
      '#2980b9',   // 14: æ·±è“è‰²
      '#f39c12',   // 15: é‡‘è‰²
      '#7f8c8d'    // 16: ç°è‰²
    ];

    // å½“å‰é€‰ä¸­çš„çŠ¶æ€
    let currentStatus = 1;
    // åœ°å›¾æ•°æ®
    let mapData = [];
    // æ˜¯å¦æ­£åœ¨æ‹–åŠ¨
    let isDragging = false;
    // æ•°å­—è®¡æ•°
    let numberCounts = Array(17).fill(0);
    // ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ•°å­—
    let nextAvailableNumber = 1;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–çŠ¶æ€é€‰æ‹©å™¨
      initStatusPicker();
      // åˆå§‹åŒ–æ•°å­—è®¡æ•°æ˜¾ç¤º
      initNumberCounts();
      // åˆ›å»ºé»˜è®¤åœ°å›¾
      createMap(10, 10);
      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      setupEventListeners();
    });

    // åˆå§‹åŒ–çŠ¶æ€é€‰æ‹©å™¨
    function initStatusPicker() {
      const picker = document.getElementById('status-picker');

      for (let i = 1; i <= 16; i++) {
        const statusOption = document.createElement('div');
        statusOption.className = `status-option status-${i}`;
        statusOption.style.backgroundColor = statusColors[i];
        statusOption.textContent = i;
        statusOption.dataset.status = i;

        if (i === currentStatus) {
          statusOption.classList.add('active');
        }

        statusOption.addEventListener('click', () => {
          if (i > 0) {
            if (i > nextAvailableNumber) {
              showNotification(`è¯·å…ˆå®Œæˆæ•°å­—${nextAvailableNumber}ï¼ˆéœ€è¦æ”¾ç½®2ä¸ªï¼‰`, "error");
              return;
            }

            if (numberCounts[i] >= 2) {
              showNotification(`æ•°å­—${i}å·²è¾¾åˆ°æœ€å¤§æ•°é‡ï¼ˆ2ä¸ªï¼‰`, "error");
              return;
            }
          }

          currentStatus = i;
          document.getElementById('current-status-box').textContent = i;
          document.getElementById('current-status-box').style.backgroundColor = statusColors[i];

          document.querySelectorAll('.status-option').forEach(opt => {
            opt.classList.remove('active');
          });
          statusOption.classList.add('active');
        });

        picker.appendChild(statusOption);
      }
    }

    // åˆå§‹åŒ–æ•°å­—è®¡æ•°æ˜¾ç¤º
    function initNumberCounts() {
      const container = document.getElementById('number-counts');

      for (let i = 1; i <= 16; i++) {
        const item = document.createElement('div');
        item.className = 'number-item';

        const colorBox = document.createElement('div');
        colorBox.className = 'number-color';
        colorBox.style.backgroundColor = statusColors[i];
        colorBox.textContent = i;

        const countText = document.createElement('span');
        countText.className = 'count-text';
        countText.textContent = `å·²æ”¾ç½®: 0/2`;
        countText.id = `count-${i}`;

        item.appendChild(colorBox);
        item.appendChild(countText);
        container.appendChild(item);
      }
    }

    // æ›´æ–°æ•°å­—è®¡æ•°æ˜¾ç¤º
    function updateNumberCounts() {
      for (let i = 1; i <= 16; i++) {
        const countElement = document.getElementById(`count-${i}`);
        if (countElement) {
          countElement.textContent = `å·²æ”¾ç½®: ${numberCounts[i]}/2`;

          if (numberCounts[i] === 2) {
            countElement.style.color = '#2ecc71';
          } else {
            countElement.style.color = 'white';
          }
        }
      }

      // æ›´æ–°ä¸‹ä¸€ä¸ªå¯ç”¨æ•°å­—
      nextAvailableNumber = 1;
      for (let i = 1; i <= 16; i++) {
        if (numberCounts[i] < 2) {
          nextAvailableNumber = i;
          break;
        }
      }
    }

    // åˆ›å»ºåœ°å›¾
    function createMap(width, height) {
      const mapGrid = document.getElementById('map-grid');
      mapGrid.innerHTML = '';

      // é‡ç½®æ•°å­—è®¡æ•°
      numberCounts = Array(17).fill(0);
      updateNumberCounts();

      // åˆå§‹åŒ–åœ°å›¾æ•°æ®
      mapData = [];

      for (let y = 0; y < height; y++) {
        const row = document.createElement('div');
        row.className = 'map-row';

        const dataRow = [];

        for (let x = 0; x < width; x++) {
          const cell = document.createElement('div');
          cell.className = 'map-cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.dataset.status = 0;
          cell.style.backgroundColor = statusColors[0];

          // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          cell.addEventListener('mousedown', startDrawing);
          cell.addEventListener('mouseenter', draw);
          cell.addEventListener('mouseup', stopDrawing);

          row.appendChild(cell);
          dataRow.push(0);
        }

        mapGrid.appendChild(row);
        mapData.push(dataRow);
      }
    }

    // å¼€å§‹ç»˜åˆ¶
    function startDrawing(e) {
      isDragging = true;
      updateCell(e.target);
    }

    // ç»˜åˆ¶ä¸­
    function draw(e) {
      if (isDragging) {
        updateCell(e.target);
      }
    }

    // åœæ­¢ç»˜åˆ¶
    function stopDrawing() {
      isDragging = false;
    }

    // æ›´æ–°å•å…ƒæ ¼
    function updateCell(cell) {
      const x = parseInt(cell.dataset.x);
      const y = parseInt(cell.dataset.y);
      const currentCellStatus = parseInt(cell.dataset.status);

      // å¦‚æœæ–°çŠ¶æ€å’Œå½“å‰çŠ¶æ€ç›¸åŒï¼Œä¸åšæ“ä½œ
      if (currentCellStatus === currentStatus) {
        if (currentStatus > 0) {
          if (currentCellStatus > 0) {
            numberCounts[currentCellStatus]--;
          }
          cell.dataset.status = 0;
          cell.textContent = '';
          cell.style.backgroundColor = statusColors[0];
        }
      } else {
        // ç‰¹æ®Šè§„åˆ™æ£€æŸ¥
        if (currentStatus > 0) {
          // æ£€æŸ¥æ˜¯å¦æ»¡è¶³é¡ºåºè§„åˆ™
          if (currentStatus > nextAvailableNumber) {
            showNotification(`è¯·å…ˆå®Œæˆæ•°å­—${nextAvailableNumber}ï¼ˆéœ€è¦æ”¾ç½®2ä¸ªï¼‰`, "error");
            return;
          }

          // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§æ•°é‡
          if (numberCounts[currentStatus] >= 2) {
            showNotification(`æ•°å­—${currentStatus}å·²è¾¾åˆ°æœ€å¤§æ•°é‡ï¼ˆ2ä¸ªï¼‰`, "error");
            return;
          }
        }

        // å‡å°‘åŸçŠ¶æ€çš„è®¡æ•°
        if (currentCellStatus > 0) {
          numberCounts[currentCellStatus]--;
        }

        // å¢åŠ æ–°çŠ¶æ€çš„è®¡æ•°
        if (currentStatus > 0) {
          numberCounts[currentStatus]++;
        }

        // æ›´æ–°UI
        cell.dataset.status = currentStatus;
        cell.textContent = currentStatus === 0 ? '' : currentStatus;
        cell.style.backgroundColor = statusColors[currentStatus];

        // æ›´æ–°æ•°æ®
        mapData[y][x] = currentStatus;
      }

      // æ›´æ–°è®¡æ•°æ˜¾ç¤º
      updateNumberCounts();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // åˆ›å»ºåœ°å›¾æŒ‰é’®
      document.getElementById('create-btn').addEventListener('click', () => {
        const width = parseInt(document.getElementById('width').value) || 10;
        const height = parseInt(document.getElementById('height').value) || 10;

        // é™åˆ¶å°ºå¯¸èŒƒå›´
        const clampedWidth = Math.min(Math.max(width, 4), 15);
        const clampedHeight = Math.min(Math.max(height, 1), 15);

        document.getElementById('width').value = clampedWidth;
        document.getElementById('height').value = clampedHeight;

        createMap(clampedWidth, clampedHeight);
        showNotification(`å·²åˆ›å»º ${clampedWidth}Ã—${clampedHeight} åœ°å›¾`, "success");
      });

      // å¯¼å‡ºæŒ‰é’®
      document.getElementById('export-json-btn').addEventListener('click', () => {
        const data = {
          width: mapData[0].length,
          height: mapData.length,
          data: mapData
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `map-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification("åœ°å›¾æ•°æ®å·²å¯¼å‡º", "success");
      });

      // å¯¼å‡ºtxtæŒ‰é’®
      document.getElementById('export-txt-btn').addEventListener('click', () => {
        const width = mapData[0].length;
        const height = mapData.length;

        // è®¡ç®—å·²ä½¿ç”¨çš„æ•°å­—ç±»å‹æ•°é‡
        updateNumberCounts();

        // å‡†å¤‡å¯¼å‡ºæ•°æ®
        let exportData = `${width} ${height} ${nextAvailableNumber - 1}`;

        // æ·»åŠ åœ°å›¾æ•°æ®
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            exportData += ` ${mapData[y][x]}`;
          }
        }

        const blob = new Blob([exportData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `map-${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      // å¯¼å…¥æŒ‰é’®
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });

      // æ–‡ä»¶è¾“å…¥
      document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.width && data.height && data.data) {
              // æ£€æŸ¥å°ºå¯¸æ˜¯å¦æœ‰æ•ˆ
              const width = Math.min(Math.max(data.width, 3), 40);
              const height = Math.min(Math.max(data.height, 1), 30);

              document.getElementById('width').value = width;
              document.getElementById('height').value = height;

              createMap(width, height);

              // åº”ç”¨å¯¼å…¥çš„æ•°æ®
              setTimeout(() => {
                // é‡ç½®æ•°å­—è®¡æ•°
                numberCounts = Array(17).fill(0);

                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    let status = 0;
                    if (y < data.data.length && x < data.data[y].length) {
                      status = data.data[y][x];
                    }

                    // æ›´æ–°è®¡æ•°
                    if (status > 0) {
                      numberCounts[status]++;
                    }

                    const cell = document.querySelector(`.map-cell[data-x="${x}"][data-y="${y}"]`);

                    if (cell) {
                      cell.dataset.status = status;
                      cell.textContent = status === 0 ? '' : status;
                      cell.style.backgroundColor = statusColors[status];
                      mapData[y][x] = status;
                    }
                  }
                }

                // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                updateNumberCounts();

                showNotification("åœ°å›¾æ•°æ®å·²å¯¼å…¥", "success");
              }, 100);
            }
          } catch (error) {
            try {
              const text = event.target.result.trim();
              const parts = text.split(/\s+/);

              if (parts.length < 3) {
                throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®");
              }

              // è§£æå‰ä¸‰ä¸ªå‚æ•°
              const width = parseInt(parts[0]);
              const height = parseInt(parts[1]);
              colorTypeCount = parseInt(parts[2]);

              // éªŒè¯å°ºå¯¸
              if (width < 3 || width > 40 || height < 1 || height > 30) {
                throw new Error("åœ°å›¾å°ºå¯¸æ— æ•ˆ");
              }

              // è®¡ç®—æ‰€éœ€æ•°æ®é•¿åº¦
              const expectedDataLength = width * height;
              if (parts.length !== 3 + expectedDataLength) {
                throw new Error("æ•°æ®é•¿åº¦ä¸åŒ¹é…");
              }

              // æ›´æ–°åœ°å›¾å°ºå¯¸
              document.getElementById('width').value = width;
              document.getElementById('height').value = height;

              // åˆ›å»ºåœ°å›¾ç½‘æ ¼
              createMap(width, height);

              // åº”ç”¨å¯¼å…¥çš„æ•°æ®
              setTimeout(() => {
                // é‡ç½®æ•°å­—è®¡æ•°
                numberCounts = Array(17).fill(0);

                let dataIndex = 3;
                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    const status = parseInt(parts[dataIndex++]);

                    // æ›´æ–°è®¡æ•°
                    if (status > 0) {
                      numberCounts[status]++;
                    }

                    const cell = document.querySelector(`.map-cell[data-x="${x}"][data-y="${y}"]`);

                    if (cell) {
                      cell.dataset.status = status;
                      cell.textContent = status === 0 ? '' : status;
                      cell.style.backgroundColor = statusColors[status];
                      mapData[y][x] = status;
                    }
                  }
                }

                // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                updateNumberCounts();

                showNotification("åœ°å›¾æ•°æ®å·²å¯¼å…¥", "success");
              }, 100);
            } catch (error) {
              showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, "error");
              console.error(error);
            }
          }
        };
        reader.readAsText(file);
      });

      // é‡ç½®æŒ‰é’®
      document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦é‡ç½®åœ°å›¾å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼')) {
          const width = parseInt(document.getElementById('width').value) || 15;
          const height = parseInt(document.getElementById('height').value) || 10;
          createMap(width, height);
          showNotification("åœ°å›¾å·²é‡ç½®", "success");
        }
      });

      // é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
      document.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('map-cell')) {
          e.preventDefault();
        }
      });
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = "success") {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type, 'show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>

</html>